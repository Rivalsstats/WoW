name: Move Existing Data to Season Layout

on:
  workflow_dispatch:
    inputs:
      season:
        description: 'Season number to assign (e.g., 14)'
        required: true
        default: '14'

jobs:
  move-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout all branches
        uses: actions/checkout@v4
        with:
          fetch-depth: 0             # fetch all history so we can check out every branch
          fetch-tags: true
          persist-credentials: true

      - name: Move data directories in each branch
        env:
          SEASON: ${{ github.event.inputs.season }}
        run: |
          set -euo pipefail

          echo "Processing all branches (except main/HEAD) to season ${SEASON} layout..."

          # Loop over every remote branch under origin/, except HEAD and main
          git branch -r \
            | grep '^  origin/' \
            | sed 's@^  origin/@@' \
            | grep -Ev '^(HEAD|main)$' \
            | while read -r branch_name; do

              echo "-- Checking out branch: ${branch_name}"
              git checkout "${branch_name}"

              # Move each data/<region>/<realm>/<period> into the new season folder
              for old_dir in data/*/*/*; do
                [ -d "${old_dir}" ] || continue

                region=$(basename "$(dirname "$(dirname "${old_dir}")")")
                realm=$(basename "$(dirname "${old_dir}")")
                period=$(basename "${old_dir}")

                new_parent="data/${region}/${realm}/${SEASON}"
                new_dir="${new_parent}/${period}"

                mkdir -p "${new_parent}"
                if git mv "${old_dir}" "${new_dir}"; then
                  echo "  Moved ${old_dir} â†’ ${new_dir}"
                else
                  echo "  No files to move in ${old_dir}"
                fi
              done

              # Commit & push if anything moved
              if ! git diff --quiet; then
                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"
                git commit -am "chore: migrate data to season ${SEASON} layout"
                git push origin "${branch_name}"
              else
                echo "  No data changes on ${branch_name}"
              fi

            done

          # back to main when done
          git checkout main

      - name: Summary
        run: |
          echo "ðŸŽ‰ Migration to season ${SEASON} complete on all branches."

name: Cleanup WoW Data Structure

on:
  workflow_dispatch:
    inputs:
      season:
        description: 'Season number to keep (e.g., 14)'
        required: true
        default: '14'

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout all branches
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          persist-credentials: true

      - name: Prune and retain only correct files
        env:
          SEASON: ${{ github.event.inputs.season }}
        run: |
          set -euo pipefail
          echo "Cleaning up data structure for season $SEASON"

          git for-each-ref --format='%(refname:short)' refs/remotes/origin/* \
            | grep '^origin/[^/]\+$' \
            | grep -vE '^(origin/HEAD|origin/main)$' \
            | sed 's@^origin/@@' \
            | while read -r branch; do

              echo "â†’ Branch: $branch"
              git checkout -q --track origin/"$branch"

              find data -type f \
                ! -path "data/*/*/${SEASON}/*/runs.csv" \
                ! -path "data/*/*/${SEASON}/*/equipment/*" \
                ! -path "data/*/*/${SEASON}/*/specializations/*" \
                -print0 \
              | xargs -0 git rm --ignore-unmatch

              find data -type d -empty -print0 \
              | xargs -0 git rm --ignore-unmatch -r

              # commit & push if there were deletions
              if git diff --cached --quiet; then
                echo "Nothing to clean on $branch"
              else
                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"
                git commit -m "chore: prune data to season ${SEASON} layout"
                git push --set-upstream origin "$branch"
              fi
            done

          git checkout main
          echo "Cleanup complete for season $SEASON"

